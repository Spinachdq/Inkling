/**
 * 标准分类：一级大类 + 二级小类，每张卡片的 parent_category 存二级小类。
 */
(function (global) {
  'use strict';

  /** 二级小类 -> 一级大类（用于星空图同门判定） */
  var SUB_TO_PARENT = {
    '民俗': '文化历史', '人类学': '文化历史', '历史考古': '文化历史', '传统习俗': '文化历史',
    '绘画': '艺术审美', '雕塑': '艺术审美', '设计': '艺术审美', '建筑': '艺术审美', '审美': '艺术审美', '摄影': '艺术审美', '音乐': '艺术审美', '舞蹈': '艺术审美',
    '电影': '影视娱乐', '电视剧': '影视娱乐', '综艺': '影视娱乐', '纪录片': '影视娱乐', '动画': '影视娱乐', '短视频': '影视娱乐', '直播': '影视娱乐',
    '诗歌': '文学创作', '小说': '文学创作', '散文': '文学创作', '戏剧': '文学创作', '写作': '文学创作', '书籍': '文学创作',
    '翻译': '语言学', '外语': '语言学', '语义学': '语言学',
    '经济': '经济金融', '货币': '经济金融', '证券投资': '经济金融', '财政政策': '经济金融',
    '商业模式': '商业贸易', '市场营销': '商业贸易', '品牌': '商业贸易', '战略': '商业贸易', '创业': '商业贸易', '供应链': '商业贸易', '零售': '商业贸易', '电商': '商业贸易', '本地生活': '商业贸易',
    '企业管理': '管理组织',
    '人工智能': '科技前沿', '具身智能': '科技前沿', '互联网': '科技前沿', '半导体': '科技前沿', '通信': '科技前沿', '软件开发': '科技前沿',
    '数学': '基础科学', '物理': '基础科学', '化学': '基础科学', '生物': '基础科学', '地理': '基础科学', '天文': '基础科学',
    '汽车': '工业制造', '能源': '工业制造', '材料': '工业制造', '机械工程': '工业制造', '航天': '工业制造',
    '社会议题': '社会议题', '性别研究': '社会议题', '城市化': '社会议题', '公共舆论': '社会议题', '人口': '社会议题', '环境': '社会议题',
    '政治': '政治外交', '军事': '政治外交', '外交': '政治外交', '治理': '政治外交',
    '法律': '法律法务',
    '教育': '教育成长',
    '临床医学': '医疗健康', '生物医药': '医疗健康', '公共卫生': '医疗健康', '药理': '医疗健康', '心理学': '医疗健康',
    '体育竞技': '体育竞技', '健身': '体育竞技',
    '美食': '生活方式', '旅行': '生活方式', '家居': '生活方式', '时尚': '生活方式', '育儿': '生活方式', '宠物': '生活方式', '情感': '生活方式',
    '逻辑学': '哲学思想', '伦理': '哲学思想', '宗教': '哲学思想', '价值观': '哲学思想',
    '其他': '其他'
  };

  /** 标准分类列表（二级小类，用于下拉与归一化） */
  var STANDARD_CATEGORIES = [
    '民俗', '人类学', '历史考古', '传统习俗',
    '绘画', '雕塑', '设计', '建筑', '审美', '摄影', '音乐', '舞蹈',
    '电影', '电视剧', '综艺', '纪录片', '动画', '短视频', '直播',
    '诗歌', '小说', '散文', '戏剧', '写作', '书籍',
    '翻译', '外语', '语义学',
    '经济', '货币', '证券投资', '财政政策',
    '商业模式', '市场营销', '品牌', '战略', '创业', '供应链', '零售', '电商', '本地生活',
    '企业管理',
    '人工智能', '具身智能', '互联网', '半导体', '通信', '软件开发',
    '数学', '物理', '化学', '生物', '地理', '天文',
    '汽车', '能源', '材料', '机械工程', '航天',
    '社会议题', '性别研究', '城市化', '公共舆论', '人口', '环境',
    '政治', '军事', '外交', '治理',
    '法律',
    '教育',
    '临床医学', '生物医药', '公共卫生', '药理', '心理学',
    '体育竞技', '健身',
    '美食', '旅行', '家居', '时尚', '育儿', '宠物', '情感',
    '逻辑学', '伦理', '宗教', '价值观',
    '其他'
  ];

  /** 默认分类（无法映射时使用） */
  var DEFAULT_CATEGORY = '其他';

  /** 旧分类或常见写法 -> 二级小类（用于存量迁移与 AI 结果归一化） */
  var OLD_TO_STANDARD = {
    '其他': '其他',
    '文化历史': '历史考古',
    '文化': '民俗',
    '历史': '历史考古',
    '艺术审美': '设计',
    '艺术': '设计',
    '美术': '绘画',
    '影视娱乐': '电影',
    '文学创作': '书籍',
    '文学': '书籍',
    '语言学': '外语',
    '经济金融': '经济',
    '宏观经济': '经济',
    '微观经济': '经济',
    '金融': '证券投资',
    '投资': '证券投资',
    '证券': '证券投资',
    '商业贸易': '市场营销',
    '商业': '市场营销',
    '商业模式': '商业模式',
    '模式': '商业模式',
    '行业研究': '战略',
    '贸易': '零售',
    '营销': '市场营销',
    '品牌战略': '品牌',
    '管理组织': '企业管理',
    '管理': '企业管理',
    '企业': '企业管理',
    '领导力': '企业管理',
    '人力资源': '企业管理',
    '科技前沿': '人工智能',
    '科技': '人工智能',
    'AI': '人工智能',
    '机器人': '人工智能',
    '软件': '软件开发',
    '编程': '软件开发',
    '基础科学': '数学',
    '科学': '数学',
    '工业制造': '汽车',
    '工业': '汽车',
    '制造': '机械工程',
    '机械': '机械工程',
    '政治外交': '政治',
    '国际关系': '外交',
    '法律法务': '法律',
    '法务': '法律',
    '教育成长': '教育',
    '成长': '教育',
    '医疗健康': '临床医学',
    '医疗': '临床医学',
    '健康': '临床医学',
    '医学': '临床医学',
    '心理认知': '心理学',
    '认知': '心理学',
    '神经': '心理学',
    '运动': '体育竞技',
    '生活方式': '美食',
    '旅游': '旅行',
    '美容': '时尚',
    '哲学思想': '伦理',
    '哲学': '伦理',
    '思想': '伦理',
    '逻辑': '逻辑学',
    '宗教': '宗教',
    '环保': '环境',
    '环境科学': '环境',
    '生态': '环境',
    '气候': '环境',
    '可持续发展': '环境'
  };

  /**
   * 将任意 parent_category 归一化为标准分类（二级小类）之一。
   */
  function normalizeParentCategory(value) {
    var s = (value && String(value).trim()) || '';
    if (!s) return DEFAULT_CATEGORY;
    for (var i = 0; i < STANDARD_CATEGORIES.length; i++) {
      if (STANDARD_CATEGORIES[i] === s) return s;
    }
    if (OLD_TO_STANDARD[s]) return OLD_TO_STANDARD[s];
    for (var key in OLD_TO_STANDARD) {
      if (key.length >= 2 && s.indexOf(key) !== -1) return OLD_TO_STANDARD[key];
    }
    return DEFAULT_CATEGORY;
  }

  /**
   * 迁移存量笔记：将每条笔记的 parent_category 归一化为当前标准分类并写回 localStorage。
   * 可在控制台调用：window.migrateNotesToStandardCategories()
   */
  function migrateNotesToStandardCategories() {
    var STORAGE_KEY = 'notes';
    var list;
    try {
      var raw = localStorage.getItem(STORAGE_KEY);
      list = raw ? JSON.parse(raw) : [];
    } catch (e) {
      return { ok: false, message: '读取笔记失败', updated: 0 };
    }
    if (!Array.isArray(list)) return { ok: false, message: '数据格式错误', updated: 0 };
    var updated = 0;
    for (var i = 0; i < list.length; i++) {
      var n = list[i];
      var oldCat = (n.parent_category && String(n.parent_category).trim()) || '';
      var newCat = normalizeParentCategory(oldCat);
      if (oldCat !== newCat) {
        n.parent_category = newCat;
        updated++;
      } else if (!oldCat) {
        n.parent_category = newCat;
        updated++;
      }
    }
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    } catch (e) {
      return { ok: false, message: '写入失败', updated: updated };
    }
    return { ok: true, updated: updated, total: list.length };
  }

  global.STANDARD_CATEGORIES = STANDARD_CATEGORIES;
  global.SUB_TO_PARENT = SUB_TO_PARENT;
  global.normalizeParentCategory = normalizeParentCategory;
  global.migrateNotesToStandardCategories = migrateNotesToStandardCategories;
})(typeof window !== 'undefined' ? window : this);
