<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>笔落皆所思，寸墨藏山河 — 碎片化内容整理</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>✒</text></svg>" type="image/svg+xml">
  <style>
    .file-protocol-tip { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); color: #fff; z-index: 9999; align-items: center; justify-content: center; flex-direction: column; padding: 2rem; text-align: center; font-family: sans-serif; }
    .file-protocol-tip.show { display: flex; }
    .file-protocol-tip h2 { margin-bottom: 1rem; font-size: 1.25rem; }
    .file-protocol-tip p { margin: 0.5rem 0; opacity: 0.9; font-size: 14px; }
    .file-protocol-tip code { background: rgba(255,255,255,0.15); padding: 2px 8px; border-radius: 4px; }
    .file-protocol-tip a { color: #7dd3fc; }
  </style>
</head>
<body>
  <!-- 检测是否通过 file:// 打开，若是则提示必须用本地服务 -->
  <div class="file-protocol-tip" id="fileProtocolTip">
    <h2>请通过本地服务访问</h2>
    <p>当前是直接打开文件（file://），链导入、AI 总结等功能需要本地服务器才能使用。</p>
    <p>请先运行：<code>python server.py</code></p>
    <p>然后在浏览器地址栏输入：<a href="http://localhost:8080" target="_blank">http://localhost:8080</a></p>
    <p style="margin-top:1rem;font-size:12px;opacity:0.7">关闭本页后，从上述地址进入即可正常使用。</p>
  </div>
  <script>
    (function(){ if (window.location.protocol === 'file:') document.getElementById('fileProtocolTip').classList.add('show'); })();
  </script>
  <main class="page-home">
    <!-- 顶部栏：右侧登录/用户菜单 -->
    <div class="top-bar">
      <div class="top-bar-inner">
        <span class="top-bar-placeholder"></span>
        <div id="userMenuContainer" class="user-menu-wrap"></div>
      </div>
    </div>
    <!-- 上层：slogan（衬线体 + 水墨装饰 + 下划线动画） -->
    <header class="slogan-block">
      <div class="slogan-blobs" aria-hidden="true">
        <div class="slogan-blob slogan-blob-terracotta"></div>
        <div class="slogan-blob slogan-blob-sage"></div>
        <div class="slogan-blob slogan-blob-amber"></div>
      </div>
      <h1 class="slogan-title">
        <span class="slogan-line">
          笔落皆所思
          <span class="slogan-underline slogan-underline-terracotta"></span>
        </span>
        <span class="slogan-comma">，</span>
        <span class="slogan-line">
          寸墨藏山河
          <span class="slogan-underline slogan-underline-sage"></span>
        </span>
      </h1>
      <p class="slogan-sub">让碎片化的灵感，沉淀为有温度的笔记</p>
    </header>

    <!-- 中层：4 个圆形功能键（Lovable ActionButtons 风格） -->
    <nav class="actions-row">
      <button type="button" class="action-btn" data-id="note" title="随手记 — 记录灵感与感悟">
        <div class="action-btn-circle">
          <span class="action-btn-ring" aria-hidden="true"></span>
          <span class="action-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><path d="M13 18l-5-5"/></svg></span>
        </div>
        <span class="label">随手记</span>
      </button>
      <button type="button" class="action-btn" data-id="link" title="链导入 — 解析外部链接">
        <div class="action-btn-circle">
          <span class="action-btn-ring" aria-hidden="true"></span>
          <span class="action-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg></span>
        </div>
        <span class="label">链导入</span>
      </button>
      <button type="button" class="action-btn" data-id="doc" title="文上传 — 导入本地文档">
        <div class="action-btn-circle">
          <span class="action-btn-ring" aria-hidden="true"></span>
          <span class="action-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></span>
        </div>
        <span class="label">文上传</span>
      </button>
      <button type="button" class="action-btn" data-id="ai" title="AI创作 — 智能对话创作">
        <div class="action-btn-circle">
          <span class="action-btn-ring" aria-hidden="true"></span>
          <span class="action-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg></span>
        </div>
        <span class="label">AI创作</span>
      </button>
    </nav>

    <!-- 下层：卡片展示区 / 星空图谱 -->
    <section class="cards-section">
      <div class="sort-bar">
        <div class="sort-bar-left">
          <span>展示：</span>
          <button type="button" class="sort-btn active" data-sort="random">随机展示</button>
          <button type="button" class="sort-btn" data-sort="date">按日期</button>
          <button type="button" class="sort-btn" data-sort="category">按分类展示</button>
        </div>
        <div class="view-toggle">
          <button type="button" class="view-toggle-btn active" data-view="card" title="卡片视图">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
            卡片
          </button>
          <button type="button" class="view-toggle-btn" data-view="graph" title="星空图谱">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg>
            星空
          </button>
        </div>
      </div>

      <div class="cards-view" id="cardsView">
        <div class="cards-grid cards-grid-date" id="cardsGrid"></div>
      </div>
      <div class="constellation-wrap" id="constellationWrap" style="display:none;">
        <div class="constellation-inner" id="constellationInner"></div>
        <div class="constellation-zoom-controls" aria-label="缩放控制">
          <button type="button" class="constellation-zoom-btn" data-zoom="in" title="放大">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
          <button type="button" class="constellation-zoom-btn" data-zoom="out" title="缩小">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
          <span class="constellation-zoom-divider"></span>
          <button type="button" class="constellation-zoom-btn" data-zoom="fullscreen" title="进入全屏" aria-label="进入全屏">
            <svg class="constellation-fullscreen-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>
          </button>
        </div>
      </div>
      <div class="cards-empty" id="cardsEmpty" style="display:none;">
        暂无笔记，点击上方功能键开始记录吧
      </div>
    </section>
  </main>

  <!-- 弹窗：链导入 -->
  <div class="modal-overlay" id="modalLink">
    <div class="modal">
      <h3>链导入</h3>
      <div class="input-wrap">
        <input type="url" id="linkInput" placeholder="粘贴公众号、小红书、知乎或网页链接">
        <p class="hint">支持微信公众号、小红书等合规链接</p>
      </div>
      <div class="loader-wrap" id="linkLoader">
        <span class="loader"></span>
        <span>解析中，请稍候…</span>
      </div>
      <div class="btns">
        <button type="button" class="cancel-btn">取消</button>
        <button type="button" class="primary parse-btn">解析</button>
      </div>
    </div>
  </div>

  <!-- 弹窗：文上传 -->
  <div class="modal-overlay" id="modalDoc">
    <div class="modal">
      <h3>文上传</h3>
      <div class="upload-zone" id="uploadZone">
        <div class="icon">📁</div>
        <div class="tip">将 Word、PDF、TXT 文件拖至此处，或点击上传</div>
      </div>
      <input type="file" id="fileInput" accept=".doc,.docx,.pdf,.txt" multiple style="display:none">
      <div class="progress" id="uploadProgress">
        <div class="bar" id="uploadBar"></div>
      </div>
      <p class="hint" style="margin-top:8px">仅支持 Word、PDF、TXT 格式，图片式 PDF 暂不支持</p>
      <div class="btns" style="margin-top:1rem">
        <button type="button" class="cancel-btn">取消</button>
      </div>
    </div>
  </div>

  <!-- 删除确认 -->
  <div class="confirm-overlay" id="confirmDelete">
    <div class="confirm-box">
      <p class="text">确定删除该笔记吗？删除后不可恢复。</p>
      <div class="btns">
        <button type="button" class="cancel-confirm">取消</button>
        <button type="button" class="danger confirm-delete">删除</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- 登录弹窗：Google + 邮箱登录/注册 -->
  <div class="modal-overlay modal-login" id="loginModal">
    <div class="modal modal-login-box">
      <button type="button" class="modal-close" data-login-close aria-label="关闭">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
      <h3 class="modal-login-title" id="loginModalTitle">登录你的知识图谱</h3>
      <p class="modal-login-desc" id="loginModalDesc">登录后可永久保存笔记并同步至所有设备</p>

      <div id="loginViewOptions" class="login-view">
        <button type="button" class="btn-login-option" id="loginBtnGoogle">
          <svg class="btn-login-google-icon" viewBox="0 0 24 24" width="20" height="20">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          使用 Google 账号登录
        </button>
        <button type="button" class="btn-login-option" id="loginBtnEmail">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          使用邮箱登录
        </button>
      </div>

      <div id="loginViewEmail" class="login-view" style="display:none">
        <form id="loginEmailForm" class="login-email-form">
          <label class="login-label">邮箱</label>
          <input type="email" id="loginEmailInput" class="login-input" placeholder="your@email.com" required />
          <label class="login-label">密码</label>
          <input type="password" id="loginPasswordInput" class="login-input" placeholder="至少 6 位" required minlength="6" />
          <button type="submit" class="btn-login-submit" id="loginFormSubmit" data-mode="login">登录</button>
          <p class="login-toggle-wrap"><span id="loginToggleHint">还没有账号？</span> <a href="#" id="loginToggleSignup">注册</a></p>
        </form>
        <button type="button" class="login-back" id="loginBackToOptions">← 返回其他登录方式</button>
      </div>
    </div>
  </div>

  <!-- 文件预览弹窗（文上传来源：PDF/Word 预览） -->
  <div class="file-preview-overlay" id="filePreviewModal" aria-hidden="true">
    <div class="file-preview-box">
      <div class="file-preview-header">
        <span class="file-preview-title" id="filePreviewTitle">原文件</span>
        <button type="button" class="file-preview-close" id="filePreviewClose" aria-label="关闭">×</button>
      </div>
      <div class="file-preview-body">
        <iframe id="filePreviewIframe" class="file-preview-iframe" title="文件预览"></iframe>
        <div id="filePreviewFallback" class="file-preview-fallback" style="display:none"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="config.js"></script>
  <script src="js/categories.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/file-preview.js"></script>
  <script src="js/ai-service.js"></script>
  <script src="js/constellation-view.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
