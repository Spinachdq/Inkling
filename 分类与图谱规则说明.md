# 分类标签体系与星空图谱规则说明

本文档说明当前项目中：**分类标签体系**（一级大类 + 二级小类）、**按分类展示**所用规则，以及**星空知识图谱**中节点与连线的计算与布局规则。

---

## 一、分类标签体系是什么？

每张卡片（笔记）上有两套与「分类」相关的字段：

| 字段 | 含义 | 展示位置 |
|------|------|----------|
| **tags** | 1～3 个具体标签，如「职场技巧」「AI 硬件」「文学感悟」 | 卡片顶部标签、编辑页标签区 |
| **parent_category** | **必须为二级小类之一**（见下），用于聚合展示与图谱 | 编辑页「分类」下拉、按分类展示分组、星空图谱连线权重 |

- **标签 (tags)**：用户可手动增删改，保存时若启用 AI 也会由 AI 生成 1～3 个。
- **父类 (parent_category)**：**固定标准分类 1 选 1**，存的是**二级小类**；一级大类仅用于星空图「同门」判定。标准列表见 `js/categories.js` 的 `STANDARD_CATEGORIES`，缺省/无法识别时为「其他」。

### 一级大类与二级小类

- **一级大类**（20 个）：文化历史、艺术审美、影视娱乐、文学创作、语言学、经济金融、商业贸易、管理组织、科技前沿、基础科学、工业制造、社会议题、政治外交、法律法务、教育成长、医疗健康、体育竞技、生活方式、哲学思想、其他。
- **二级小类**：每个一级大类下对应若干二级小类，例如文化历史 → 民俗、人类学、历史考古、传统习俗；艺术审美 → 绘画、雕塑、设计、建筑、审美、摄影、音乐、舞蹈；影视娱乐 → 电影、电视剧、综艺、纪录片、动画、短视频、直播；商业贸易 → 商业模式、市场营销、品牌、战略、创业、供应链、零售、电商、本地生活；等等。完整映射见 `js/categories.js` 的 `SUB_TO_PARENT`。
- 编辑页下拉框与 AI 打标均使用**二级小类**列表；存量笔记通过迁移统一归一化到当前二级小类。

---

## 二、平台根据什么规则/模型确定每张卡片的分类（用于分类展示）？

「按分类展示」**只看 `parent_category`**（二级小类），不直接看 `tags`。

### 1. parent_category 从哪里来？

- **标准分类**：`js/categories.js` 的 `STANDARD_CATEGORIES` 列出全部二级小类（如民俗、人类学、历史考古、绘画、电影、经济、人工智能、汽车、环境、法律、教育、临床医学、体育竞技、美食、伦理、其他 等）。
- **保存时若调用了 AI**：AI 根据笔记正文从二级小类中**必须且只能选一个**作为 `parent_category`；返回后由 `normalizeParentCategory` 归一化。
- **用户手动选择**：编辑页「分类」下拉为二级小类；保存时以选中值为准并再次归一化。
- **存量数据**：首页加载时执行一次性迁移（`categories_migrated_v4`），将每条笔记的 `parent_category` 归一化为当前标准二级小类并写回 localStorage。

### 2. 按分类展示的展示规则

- 所有笔记按 **`parent_category`**（二级小类）分组，空或缺失视为「其他」。
- 分组标题按名称排序，「其他」排在最后。
- 同一父类下的卡片按 **date** 降序排列。

---

## 三、星空知识图谱：节点远近与连线规则

星空图由 **D3 力导向图** 驱动：节点 = 笔记卡片，边 = 根据「分类 + 标签」算出的综合权重 W 连线。

### 1. 哪些卡片会出现在图谱里？

- 只使用 **有有效 `id`** 的笔记。
- 无笔记或全部无 id 时，显示「暂无笔记，无法生成图谱」。

### 2. 节点属性

- **节点大小 (radius)**：内容长度 `radius = Math.min(8 + len/20, 18)`。
- **节点颜色 (tint)**：由节点 id 的 hash 映射到 5 种固定颜色。

### 3. 综合权重 W 与连线阈值

- **分类得分 S_cat**（三阶）：
  - **1.0**：二级小类完全相同（如两篇都是「汽车」）。
  - **0.5**：二级小类不同但一级大类相同（如「汽车」与「能源」同属工业制造）。
  - **0**：一级大类也不同。
- **标签得分 S_tag**（0～1）：沿用 Jaccard 近似算法，取两笔记标签对中最大相似度。
- **综合权重**：**W = (S_cat × 0.8) + (S_tag × 0.2)**。
- **连线条件**：仅当 **W ≥ 0.15** 时连一条线；W < 0.15 不连线（无缘，靠斥力散开）。

### 4. 连线视觉与物理距离（按 W 分档）

| 关联关系 | 权重区间 (W) | 连线视觉 | 物理距离 (distance) |
|----------|----------------|----------|----------------------|
| 同宗同源 | W ≥ 0.8 | 普通线 | 150 |
| 同门师兄 | 0.4 ≤ W < 0.8 | 普通线 | 330 |
| 跨界邂逅 | 0.15 ≤ W < 0.4 | 更细更淡、虚线 | 675 |
| 无缘 | W < 0.15 | 不连线 | — |

- 同宗同源：同一二级小类，紧密抱团。
- 同门师兄：同一一级大类不同二级小类，形成星团边缘。
- 跨界邂逅：分类不同但标签相似，长程连接。

### 5. 力导向

- **link 力**：有连线的节点按上表设置 `distance`；`strength` 由 W 推导。
- **charge / center / collision / x,y**：与之前一致，用于斥力、居中与防重叠。

---

## 四、规则速查表

| 问题 | 规则/模型 |
|------|-----------|
| 分类体系？ | **一级大类 + 二级小类**；卡片存 **parent_category = 二级小类**；`SUB_TO_PARENT` 提供二级→一级映射。 |
| 卡片的「分类」谁来决定？ | **parent_category** 由保存时 AI 或用户下拉选择；缺省或无法识别为「其他」。 |
| 按分类展示按什么分组？ | 按 **parent_category**（二级小类）分组；同组内按 **date** 降序。 |
| 星空图何时连线？ | **W = S_cat×0.8 + S_tag×0.2 ≥ 0.15** 时连线；S_cat 同二级=1、同一级=0.5、否则=0；S_tag 为标签 Jaccard 近似。 |
| 连线远近与样式？ | W≥0.8 距离 150；0.4≤W<0.8 距离 330；0.15≤W<0.4 距离 675、线更细更淡；W<0.15 不连线。 |

---

*文档根据当前代码整理，若后续修改了 `categories.js`、`ai-service.js`、`app.js`、`edit.js`、`constellation-view.js` 中的相关逻辑，需同步更新本文档。*
